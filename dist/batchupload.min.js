var extend=function(){if(0!==arguments.length){for(var e=Object.create({}),t=0;t<arguments.length;t++)for(var s in arguments[t])e[s]=arguments[t][s];return e}},uuid=function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?s:3&s|8).toString(16)})};if(!window.CustomEvent){var CustomEvent=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),s};CustomEvent.prototype=window.Event.prototype,window.CustomEvent=CustomEvent}var List=function(){var list={key:"this.length",length:0,list:{},get:function(e){return this.list[e]},add:function(item){var key=eval(this.key);this.list[key]=item,++this.length},remove:function(item){var key=eval(this.key);delete this.list[key],--this.length},item:function(e){var t=Object.keys(this.list),s=t[e];return this.list[s]},clear:function(){this.list={},this.length=0},toArray:function(){var e=function(){var e=[],t=this;return Object.keys(this).forEach(function(s){e.push(t[s])}),e};return e.apply(this.list)}},setItems=function(e){for(var t=0;t<e.length;t++)list.add(e[t])};return 2==arguments.length?(list.key=arguments[1],setItems(arguments[0])):1==arguments.length&&"string"==typeof arguments[0]?list.key=arguments[0]:1==arguments.length&&arguments[0]instanceof Array&&setItems(arguments[0]),list},FileUploadEvent=function(e,t){var s=extend(FileUploadEvent.DEFAULT,new CustomEvent(e),t);return s.prototype=CustomEvent.prototype,s.constructor=FileUploadEvent,s};FileUploadEvent.DEFAULT={bytesLoaded:0,bytesTotal:0,file:null},FileUploadEvent.constructor=CustomEvent;var FileManagerEvent=function(e,t){var s=extend(FileManagerEvent.DEFAULT,new CustomEvent(e),t);return s.prototype=CustomEvent.prototype,s.constructor=FileManagerEvent,s};FileManagerEvent.DEFAULT={bytesLoaded:0,bytesTotal:0,queue:{},fileList:[],completed:{}},FileManagerEvent.constructor=CustomEvent;var EventEmitter=function(){this.addEventListener=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},this.removeEventListener=function(e,t){if(this.events[e])for(var s=0;s<this.events[e].length;s++)if(this.events[e][s]===t)return this.events[e][s]=null,void this.events[e].splice(s,1)},this.removeAllListeners=function(e){this.events[e]=[]};var e=function(e,t){setTimeout(function(){e(t)},0)};this.dispatchEvent=function(t){if(t.type){var s=t.type;if(this.events[s]){t.target=this;for(var a=0;a<this.events[s].length&&(void 0===t.returnValue||t.returnValue);a++){var n=this.events[s][a];e(n.bind(t.target),t)}}}}},FileDropZone=function(e,t){this.setSettings(t),this.manager=this.settings.manager||new FileUploadManager([],this.settings),this.setElement(e)};FileDropZone.DEFAULT={url:null,method:"POST",manager:null,dragOverClass:"drag-over",allowedTypes:[],allowedExtensions:[],maxFileSize:null},FileDropZone.prototype.setSettings=function(e){this.settings=extend(FileDropZone.DEFAULT,e)},FileDropZone.prototype.setElement=function(e){var t=this;this.element=e,this.element.addEventListener("dragover",function(e){e.preventDefault()}),this.element.addEventListener("dragenter",function(e){e.target.className+=" "+t.settings.dragOverClass}),this.element.addEventListener("dragleave",function(e){e.target.className=e.target.className.replace(" "+t.settings.dragOverClass,"")}),this.element.addEventListener("drop",function(e){if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files instanceof FileList&&e.dataTransfer.files.length>0){e.preventDefault();for(var s=e.dataTransfer.files,a=0;a<s.length;a++){var n=s.item(a);t.manager.addFile(n)}e.target.className=e.target.className.replace(" "+t.settings.dragOverClass,"")}})};var FileUploadManager=function(e,t){this.events=[],this.setSettings(t);var s=function(e){var t=new FileManagerEvent("file_start",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:o.bytesLoaded,totalBytesTotal:o.bytesTotal,currentTarget:e.target,file:e.file,queue:h.toArray(),errors:u.toArray(),fileList:l,completed:d.toArray()});o.dispatchEvent(t)},a=function(e){var t=new FileManagerEvent("file_pause",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:o.bytesLoaded,totalBytesTotal:o.bytesTotal,currentTarget:e.target,file:e.file,queue:h.toArray(),errors:u.toArray(),fileList:l,completed:d.toArray()});o.dispatchEvent(t)},n=function(e){var t=new FileManagerEvent("file_progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:o.bytesLoaded,totalBytesTotal:o.bytesTotal,currentTarget:e.target,file:e.file,queue:h.toArray(),errors:u.toArray(),fileList:l,completed:d.toArray()});o.dispatchEvent(t)},i=function(e){h.remove(e.target),u.add(e.target);var t=new FileManagerEvent("file_error",{bytesLoaded:0,bytesTotal:e.bytesTotal,totalBytesLoaded:o.bytesLoaded,totalBytesTotal:o.bytesTotal,currentTarget:e.target,file:e.file,queue:h.toArray(),errors:u.toArray(),fileList:l,completed:d.toArray()});o.dispatchEvent(t),p.apply(o)},r=function(e){d.add(e.target),h.remove(e.target);var t=new FileManagerEvent("file_complete",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:o.bytesLoaded,totalBytesTotal:o.bytesTotal,currentTarget:e.target,file:e.file,queue:h.toArray(),errors:u.toArray(),fileList:l,completed:d.toArray(),data:e.data});o.dispatchEvent(t),p.apply(o)},o=this,l=[],d=new List("item.uuid"),u=new List("item.uuid"),h=new List("item.uuid");h.add=function(e){e.uuid&&(e.addEventListener("start",s),e.addEventListener("pause",a),e.addEventListener("progress",n),e.addEventListener("error",i),e.addEventListener("complete",r),this.list[e.uuid]=e,++this.length)},h.remove=function(e){e.uuid&&(e.removeEventListener("start",s),e.removeEventListener("pause",a),e.removeEventListener("progress",n),e.removeEventListener("error",i),e.removeEventListener("complete",r),delete this.list[e.uuid],--this.length)},this.bytesLoaded=0,this.bytesTotal=0,this.paused=!this.settings.autoStart,this.addFile=function(e){return!e instanceof File||!this.validate(e)?void 0:(l||(l=[]),l.push(e),this.bytesTotal+=e.size,p.apply(this),this)},this.setFiles=function(e){if(!(!e instanceof FileList||!e instanceof Array||0===e.length)){this.pause(),l=[];var t;if(e instanceof FileList)for(t=0;t<e.length;t++)this.addFile(e.item(t));else for(t=0;t<e.length;t++)this.addFile(e[t]);return 1==this.settings.autoStart&&this.start(),this}};var p=function(){for(var e=this;h.length<e.settings.maxQueue&&l.length>0;){var t=l.shift();if(t){var s=new FileUpload(t,{url:e.settings.url,method:e.settings.method,autoStart:!1});h.add(s),e.dispatchEvent(new FileManagerEvent("queue",{bytesLoaded:0,bytesTotal:t.size,totalBytesLoaded:e.bytesLoaded,totalBytesTotal:e.bytesTotal,currentTarget:s,queue:h.toArray(),file:t,fileList:l,completed:d.toArray(),errors:u.toArray()})),e.paused||s.start()}}};this.start=function(){this.paused=!1,p.apply(this);for(var e in h)h[e].start();this.dispatchEvent(FileManagerEvent("start",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,queue:h.toArray(),fileList:l,completed:d.toArray(),errors:u.toArray()}))},this.pause=function(){this.paused=!0;for(var e=0;e<h.length;e++)h[e].pause();this.dispatchEvent(new FileManagerEvent("pause",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,queue:h.toArray(),fileList:l,completed:d.toArray(),errors:u.toArray()}))},this.clearQueue=function(){return h.clear(),this},this.clearErrors=function(){return u.clear(),this},this.clearCompleted=function(){return d.clear(),this},this.setFiles(e)};FileUploadManager.DEFAULT={maxQueue:6,url:null,method:"POST",autoStart:!0,allowedTypes:[],allowedExtensions:[],maxFileSize:null},FileUploadManager.prototype=new EventEmitter,FileUploadManager.constructor=EventEmitter,FileUploadManager.prototype.validateTypes=function(e){var t=this.settings.allowedTypes;if(!t||0==t.length)return!0;for(var s=!1,a=0;a<t.length;a++)if(e.type==t[a].trim()){s=!0;break}return s},FileUploadManager.prototype.validateExts=function(e){var t=this.settings.allowedExtensions;if(!t||0==t.length)return!0;for(var s=!1,a=e.name.split("."),n=a.pop(),i=0;i<t.length;i++)if(n==t[i].trim()){s=!0;break}return s},FileUploadManager.prototype.validateSize=function(e){var t=this.settings.maxFileSize;return!t||isNaN(t)?!0:e.size<=t},FileUploadManager.prototype.validate=function(e){return this.validateSize(e)&&this.validateTypes(e)&&this.validateExts(e)},FileUploadManager.prototype.setSettings=function(e){return this.settings=extend(FileUploadManager.DEFAULT,e),this};var FileUpload=function(e,t){if(!(!e instanceof Blob)){null==t.name&&(t.filename=e.name),this.events=[];var s=this;const a=1048576;this.setSettings(t),this.paused=!this.settings.autoStart,this.bytesLoaded=0,this.bytesTotal=e.size,this.file=e,this.startTime=null,this.endTime=null,this.chunk=0,this.chunks=Math.ceil(s.bytesTotal/a);var n=function(){var e=this;if(e.settings.url&&!e.paused&&e.bytesLoaded<e.bytesTotal){++e.chunk;var t=new XMLHttpRequest;t.open(e.settings.method,e.settings.url),t.addEventListener("error",function(t){e.dispatchEvent(new FileUploadEvent("error",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,data:"string"==typeof t.response?JSON.parse(t.response):t.response,header:t.responseHeaders}))}),t.addEventListener("loadstart",function(t){t.currentTarget.upload&&t.currentTarget.upload.addEventListener&&t.currentTarget.upload.addEventListener("progress",function(t){var s=t.loaded/t.total;e.bytesLoaded=a*e.chunk*s,e.bytesLoaded>e.bytesTotal&&(e.bytesLoaded=e.bytesTotal),e.dispatchEvent(new FileUploadEvent("progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file}))})}),t.addEventListener("load",function(t){var s=t.currentTarget;return s.status<200||s.status>=400?void e.dispatchEvent(new FileUploadEvent("error",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,data:"string"==typeof t.response?JSON.parse(t.response):t.response,header:t.responseHeaders})):(e.bytesLoaded=a*e.chunk,e.bytesLoaded>e.bytesTotal&&(e.bytesLoaded=e.bytesTotal),e.dispatchEvent(new FileUploadEvent("progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,duration:(new Date).getTime()-e.startTime})),void(e.chunk<e.chunks?e.paused||n.apply(e):(e.endTime=(new Date).getTime(),e.dispatchEvent(new FileUploadEvent("complete",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,duration:e.endTime-e.startTime,data:s.getResponseHeader("Content-Type").indexOf("json")>-1&&"string"==typeof s.response?JSON.parse(s.response):s.response,header:s.responseHeaders})))))});var s=new FormData;s.append("filename",e.settings.filename),s.append("chunk",e.chunk),s.append("chunks",e.chunks),s.append(e.settings.formFileField,e.file.slice(e.bytesLoaded,e.bytesLoaded+a),e.settings.filename),t.send(s)}};this.start=function(){this.paused=!1;var e=(new Date).getTime();null===this.startTime?this.startTime=e:this.startTime=e-(this.endTime-this.startTime),this.dispatchEvent(new FileUploadEvent("start",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,filename:this.settings.filename,file:this.file})),n.apply(this)},this.pause=function(){this.paused=!0,this.endTime=(new Date).getTime(),this.dispatchEvent(new FileUploadEvent("pause",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,filename:this.settings.filename,file:this.file}))},this.uuid=uuid(),this.paused||this.start()}};FileUpload.DEFAULT={filename:null,method:"POST",url:null,autoStart:!0,formFileField:"file"},FileUpload.prototype=new EventEmitter,FileUpload.constructor=EventEmitter,FileUpload.prototype.setSettings=function(e){this.settings=extend(FileUpload.DEFAULT,e)},FileUpload.prototype.setUrl=function(e){this.settings.url=e};