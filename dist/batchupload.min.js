var extend=function(){if(0!==arguments.length){for(var e=Object.create({}),t=0;t<arguments.length;t++)for(var a in arguments[t])e[a]=arguments[t][a];return e}},uuid=function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?a:3&a|8).toString(16)})},EventBase=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var a=document.createEvent("CustomEvent");return a.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),a};EventBase.prototype=window.Event.prototype;var List=function(){var list={key:"this.length",length:0,list:{},get:function(e){return this.list[e]},add:function(item){var key=eval(this.key);return this.list[key]=item,++this.length,this},remove:function(e){for(var t in this.list)if(this.list.hasOwnProperty(t)&&this.list[t]===e){delete this.list[t];var a=new List(this.key,this.toArray());this.list=a.list,this.length=a.length;break}return this},item:function(e){var t=Object.keys(this.list)[e];return this.list[t]},clear:function(){return this.list={},this.length=0,this},toArray:function(){return function(){var e=[],t=this;return Object.keys(this).forEach(function(a){e.push(t[a])}),e}.apply(this.list)}},setItems=function(e){for(var t=0;t<e.length;t++)list.add(e[t])};return 2==arguments.length?(list.key=arguments[1],setItems(arguments[0])):1==arguments.length&&"string"==typeof arguments[0]?list.key=arguments[0]:1==arguments.length&&arguments[0]instanceof Array&&setItems(arguments[0]),list},FileUploadEvent=function(e,t){var a=extend(FileUploadEvent.DEFAULT,new EventBase(e),t);return a.prototype=EventBase.prototype,a.constructor=FileUploadEvent,a};FileUploadEvent.DEFAULT={bytesLoaded:0,bytesTotal:0,file:null},FileUploadEvent.constructor=EventBase;var FileManagerEvent=function(e,t){var a=extend(FileManagerEvent.DEFAULT,new EventBase(e),t);return a.prototype=EventBase.prototype,a.constructor=FileManagerEvent,a};FileManagerEvent.DEFAULT={bytesLoaded:0,bytesTotal:0,totalBytesLoaded:0,totalBytesTotal:0,currentTarget:null,file:null,queue:[],errors:[],fileList:[],completed:[],data:null},FileManagerEvent.INVALID_SIZE=1,FileManagerEvent.INVALID_TYPE=2,FileManagerEvent.INVALID_EXT=4,FileManagerEvent.constructor=EventBase;var EventEmitter=function(){this.on=this.addEventListener=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},this.off=this.removeEventListener=function(e,t){if(this.events[e])for(var a=0;a<this.events[e].length;a++)if(this.events[e][a]===t)return this.events[e][a]=null,void this.events[e].splice(a,1)},this.removeAllListeners=function(e){this.events[e]=[]};var e=function(e,t){setTimeout(function(){e(t)},0)};this.dispatchEvent=function(t){if(t.type){var a=t.type;if(this.events[a]){t.target=this;for(var s=0;s<this.events[a].length&&(void 0===t.returnValue||t.returnValue);s++){var i=this.events[a][s];e(i.bind(t.target),t)}}}}},FileDropZone=function(e,t){this.setSettings(t),this.manager=this.settings.manager||new FileUploadManager(this.settings),this.setElement(e)};FileDropZone.DEFAULT={url:null,method:"POST",manager:null,dragOverClass:"drag-over",maxQueue:6,autoStart:!0,allowedTypes:[],allowedExtensions:[],maxFileSize:null,maxChunkSize:1048576,formFileField:"file",chunkParameter:"chunk",chunksParameter:"chunks"},FileDropZone.prototype.setSettings=function(e){this.settings=extend(FileDropZone.DEFAULT,e)},FileDropZone.prototype.setElement=function(e){var t=this;this.element=e,this.element.addEventListener("dragover",function(e){e.preventDefault()}),this.element.addEventListener("dragenter",function(e){e.target.className+=" "+t.settings.dragOverClass}),this.element.addEventListener("dragleave",function(e){e.target.className=e.target.className.replace(" "+t.settings.dragOverClass,"")}),this.element.addEventListener("drop",function(e){if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files instanceof FileList&&e.dataTransfer.files.length>0){e.preventDefault();for(var a=e.dataTransfer.files,s=0;s<a.length;s++){var i=a.item(s);t.manager.addFile(i)}e.target.className=e.target.className.replace(" "+t.settings.dragOverClass,"")}})};var FileUploadManager=function(e){this.events=[],this.setSettings(e),this.bytesLoaded=0,this.bytesTotal=0,this.paused=!this.settings.autoStart;var t=this,a=[],s=new List("item.uuid"),i=new List("item.uuid"),n=new List("item.uuid"),r=function(e){var r=new FileManagerEvent("file_start",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray()});t.dispatchEvent(r)},o=function(e){var r=new FileManagerEvent("file_pause",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray()});t.dispatchEvent(r)},l=function(e){t.bytesLoaded+=e.bytesLoaded;var r=new FileManagerEvent("file_progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray()});t.dispatchEvent(r),r=new FileManagerEvent("progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray()}),t.dispatchEvent(r)},d=function(e){n.remove(e.target),i.add(e.target);var r=new FileManagerEvent("file_error",{bytesLoaded:0,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray(),fileError:e});t.dispatchEvent(r),r=new FileManagerEvent("error",{bytesLoaded:0,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray(),fileError:e}),t.dispatchEvent(r),h.apply(t)},u=function(e){s.add(e.target),n.remove(e.target);var r=new FileManagerEvent("file_complete",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray(),data:e.data});t.dispatchEvent(r),r=new FileManagerEvent("complete",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:e.target,file:e.file,queue:n.toArray(),errors:i.toArray(),fileList:a,completed:s.toArray(),data:e.data}),t.dispatchEvent(r),h.apply(t)};n.add=function(e){e.uuid&&(e.on("start",r),e.on("pause",o),e.on("progress",l),e.on("error",d),e.on("complete",u),this.list[e.uuid]=e,++this.length)},n.remove=function(e){e.uuid&&(e.off("start",r),e.off("pause",o),e.off("progress",l),e.off("error",d),e.off("complete",u),delete this.list[e.uuid],--this.length)},this.addFile=function(e){if(!(!e instanceof File)&&this.validate(e))return a||(a=[]),a.push(e),this.bytesTotal+=e.size,h.apply(this),this;if(e instanceof File){i.add(e);var r=new FileManagerEvent("invalid",{bytesLoaded:0,bytesTotal:e.size,totalBytesLoaded:t.bytesLoaded,totalBytesTotal:t.bytesTotal,currentTarget:this,queue:n.toArray(),file:e,fileList:a,completed:s.toArray(),errors:i.toArray()});this.dispatchEvent(r)}},this.setFiles=function(e){if(!(!e instanceof FileList||!e instanceof Array||0===e.length)){this.pause(),a=[];var t;if(e instanceof FileList)for(t=0;t<e.length;t++)this.addFile(e.item(t));else for(t=0;t<e.length;t++)this.addFile(e[t]);return!0===this.settings.autoStart&&this.start(),this}};var h=function(){for(var e=this;n.length<e.settings.maxQueue&&a.length>0;){var t=a.shift();if(t){var r=new FileUpload(t,{url:e.settings.url,method:e.settings.method,autoStart:!1,maxChunkSize:e.settings.maxChunkSize,formFileField:e.settings.formFileField,chunkParameter:e.settings.chunkParameter,chunksParameter:e.settings.chunksParameter});e.bytesTotal+=t.size,n.add(r),e.dispatchEvent(new FileManagerEvent("queue",{bytesLoaded:0,bytesTotal:t.size,totalBytesLoaded:e.bytesLoaded,totalBytesTotal:e.bytesTotal,currentTarget:r,queue:n.toArray(),file:t,fileList:a,completed:s.toArray(),errors:i.toArray()})),e.paused||r.start()}}};this.start=function(){this.paused=!1,h.apply(this);for(var e in n.list)n.get(e).start();this.dispatchEvent(FileManagerEvent("start",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,queue:n.toArray(),fileList:a,completed:s.toArray(),errors:i.toArray()}))},this.pause=function(){this.paused=!0;for(var e=0;e<n.length;e++)n[e].pause();this.dispatchEvent(new FileManagerEvent("pause",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,queue:n.toArray(),fileList:a,completed:s.toArray(),errors:i.toArray()}))},this.clearQueue=function(){return n.clear(),this},this.clearErrors=function(){return i.clear(),this},this.clearCompleted=function(){return s.clear(),this}};FileUploadManager.DEFAULT={maxQueue:6,url:null,method:"POST",autoStart:!0,allowedTypes:[],allowedExtensions:[],maxFileSize:null,maxChunkSize:1048576,formFileField:"file",chunkParameter:"chunk",chunksParameter:"chunks"},FileUploadManager.prototype=new EventEmitter,FileUploadManager.constructor=EventEmitter,FileUploadManager.prototype.validateTypes=function(e){var t=this.settings.allowedTypes;if(!t||0==t.length)return!0;for(var a=!1,s=0;s<t.length;s++)if(e.type==t[s].trim()){a=!0;break}return a},FileUploadManager.prototype.validateExts=function(e){var t=this.settings.allowedExtensions;if(!t||0==t.length)return!0;for(var a=!1,s=e.name.split(".").pop(),i=0;i<t.length;i++)if(s==t[i].trim()){a=!0;break}return a},FileUploadManager.prototype.validateSize=function(e){var t=this.settings.maxFileSize;return!(t&&!isNaN(t))||e.size<=t},FileUploadManager.prototype.validate=function(e){if(!(size=this.validateSize(e))||!(type=this.validateTypes(e))||!(ext=this.validateExts(e))){var t=new FileManagerEvent("invalid",{file:e,reason:(size&&FileManagerEvent.INVALID_SIZE)|(type&&FileManagerEvent.INVALID_TYPE)|(ext&&FileManagerEvent.INVALID_EXT)});this.dispatchEvent(t)}return!1},FileUploadManager.prototype.setSettings=function(e){return this.settings=extend(FileUploadManager.DEFAULT,e),this};var FileUpload=function(e,t){if(!(!e instanceof Blob)){null==t.name&&(t.filename=e.name),this.events=[];var a=this;this.setSettings(t);var s=this.settings.maxChunkSize;this.paused=!this.settings.autoStart,this.bytesLoaded=0,this.bytesTotal=e.size,this.file=e,this.startTime=null,this.endTime=null,this.chunk=0,this.chunks=Math.ceil(a.bytesTotal/s);var i=function(){var e=this;if(e.settings.url&&!e.paused&&e.bytesLoaded<e.bytesTotal){++e.chunk;var t=new XMLHttpRequest;t.open(e.settings.method,e.settings.url),t.addEventListener("error",function(t){e.dispatchEvent(new FileUploadEvent("error",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,data:"string"==typeof t.response?JSON.parse(t.response):t.response,header:t.responseHeaders}))}),t.addEventListener("loadstart",function(t){t.currentTarget.upload&&t.currentTarget.upload.addEventListener&&t.currentTarget.upload.addEventListener("progress",function(t){var a=t.loaded/t.total;e.bytesLoaded=s*e.chunk*a,e.bytesLoaded>e.bytesTotal&&(e.bytesLoaded=e.bytesTotal),e.dispatchEvent(new FileUploadEvent("progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file}))})}),t.addEventListener("load",function(t){var a=t.currentTarget;a.status<200||a.status>=400?e.dispatchEvent(new FileUploadEvent("error",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,data:"string"==typeof t.response?JSON.parse(t.response):t.response,header:t.responseHeaders})):(e.bytesLoaded=s*e.chunk,e.bytesLoaded>e.bytesTotal&&(e.bytesLoaded=e.bytesTotal),e.dispatchEvent(new FileUploadEvent("progress",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,duration:(new Date).getTime()-e.startTime})),e.chunk<e.chunks?e.paused||i.apply(e):(e.endTime=(new Date).getTime(),e.dispatchEvent(new FileUploadEvent("complete",{bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal,filename:e.settings.filename,file:e.file,duration:e.endTime-e.startTime,data:a.getResponseHeader("Content-Type").indexOf("json")>-1&&"string"==typeof a.response?JSON.parse(a.response):a.response,header:a.responseHeaders}))))});var a=new FormData;a.append("filename",e.settings.filename),a.append(e.settings.chunkParameter,e.chunk),a.append(e.settings.chunksParameter,e.chunks),a.append(e.settings.formFileField,e.file.slice(e.bytesLoaded,e.bytesLoaded+s),e.settings.filename),t.send(a)}};this.start=function(){this.paused=!1;var e=(new Date).getTime();return null===this.startTime?this.startTime=e:this.startTime=e-(this.endTime-this.startTime),this.dispatchEvent(new FileUploadEvent("start",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,filename:this.settings.filename,file:this.file})),i.apply(this),this},this.pause=function(){return this.paused=!0,this.endTime=(new Date).getTime(),this.dispatchEvent(new FileUploadEvent("pause",{bytesLoaded:this.bytesLoaded,bytesTotal:this.bytesTotal,filename:this.settings.filename,file:this.file})),this},this.reset=function(){var e=this.paused;return this.pause(),this.chunk=0,this.bytesLoaded=0,this.startTime=(new Date).getTime(),e||this.start(),this},this.uuid=uuid(),this.paused||this.start()}};FileUpload.DEFAULT={filename:null,method:"POST",url:null,autoStart:!0,formFileField:"file",chunkParameter:"chunk",chunksParameter:"chunks",maxChunkSize:1048576},FileUpload.prototype=new EventEmitter,FileUpload.constructor=EventEmitter,FileUpload.prototype.setSettings=function(e){this.settings=extend(FileUpload.DEFAULT,e)},FileUpload.prototype.setUrl=function(e){this.settings.url=e},window.FileUploadManager=FileUploadManager,window.FileUpload=FileUpload,window.FileUploadEvent=FileUploadEvent,window.FileDropZone=FileDropZone;